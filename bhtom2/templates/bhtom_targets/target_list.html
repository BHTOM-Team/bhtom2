{% extends 'bhtom_common/base.html' %}
{% load bootstrap4 targets_extras bhtom_targets_extras dataproduct_extras cache%}
{% block title %}Targets{% endblock %}
{% block content %}
<div class="row">
    <!-- target list is being displayed for the whole range of the page -->
    <div class="col-md-12">
        <div class="row">
            <div class="col-md-12">
                <span class="float-right" style="color: rgb(43, 158, 203);">
                    {{ target_count }} {% if target_count == 1 %}Target{% else %}Targets{% endif %} &nbsp;
                    <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Create Targets
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" href="{% url 'targets:create' %}" title="Create a Target">Create a
                            Target</a>
                        <a class="dropdown-item" href="{% url 'targets:import' %}" title="Import Targets">Import
                            Targets</a>
                        <a class="dropdown-item" href="{% url 'bhtom2.bhtom_catalogs:query' %}"
                            title="Catalog Search">Catalog Search</a>
                    </div>
                    {% update_broker_data_button %}
                    <button onclick="document.getElementById('invisible-export-button').click()"
                        class="btn btn-primary">Export Filtered Targets</button>
                    <!-- use an invisible button, because the key "Enter" event will triggered the first submit button and we want the default action to be applying filter -->
                </span>
            </div>
        </div>

        {% select_target_js %}
        {% cache 3600 target_distribution_cache object_list %}
        {% target_distribution filter.qs %}
        {% endcache %}

        <label id="displaySelected"></label>
        <button id="optionSelectAll" type="button" class="btn btn-link"
            onClick="select_all({{ target_count }})"></button>
        <form id="grouping-form" action="{% url 'targets:add-remove-grouping' %}" method="POST">
            {% csrf_token %}
            <div class="form-group d-flex justify-content-end align-items-baseline">
                <label>Add/Remove from grouping</label>
                <select name="grouping" class="form-control w-25 ml-1">
                    {% for grouping in groupings %}
                    <option value="{{ grouping.id }}">{{ grouping.name }}</option>
                    {% endfor %}
                </select>

                <input type="hidden" value="{{ query_string }}" name="query_string">
                <input type="hidden" value="False" id="isSelectAll" name="isSelectAll">
                <button type="submit" class="btn btn-outline-primary ml-1" name="add">Add</button>
                <button type="submit" class="btn btn-outline-primary ml-1" name="move">Move</button>
                <button type="submit" class="btn btn-outline-danger ml-1" name="remove">Remove</button>
            </div>

            {% cache 3600 targets_list_cache object_list %}

            <table class="table table-hover sortable">
                <thead>
                    <tr>
                        <th><label><input type="checkbox" id="selectPage"
                                    onClick="select_page(this, {{ target_count }})" /></label></th>
                        <th>Names</th>
                        <th>RA</th>
                        <th>Dec</th>
                        <th>Nobs</th>
                        <th>Last Gmag</th>
                        <th>Last Filter</th>
                        <th>Importance</th>
                        <th>Created</th>
                        <th>Priority</th>
                        <th>Sun</th>
                        <th>Class</th>
                    </tr>
                </thead>
                <tbody>
                    {% for target in object_list %}
                    <tr>
                        <td><label>
                                <input type="checkbox" name="selected-target" value="{{ target.id }}"
                                    onClick="single_select()" />
                            </label></td>
                        <td>
                            <a href="{% url 'targets:detail' target.name %}" title="{{ target.name }}">{{
                                target.names|join:", " }}</a>
                        </td>

                        <td>{{ target.ra|deg_to_sexigesimal:"hms" }}</td>
                        <td>{{ target.dec|deg_to_sexigesimal:"dms" }}</td>
                        <td>{{ target.reduceddatum_set.count }}</td>
                        <td>{{ target.last_mag|floatformat:1 }}</td>
                        <td>{{ target.last_filter }}</td>
                        <td>{{ target.importance }}</td>
                        <td>{{ target.created }}</td>
                        <td>
                            {% if target.cadencepriority >= 10 %}
                            <div class="red">
                                {% else %}
                                <div>
                                    {% endif %}
                                    {{ target.cadencepriority|floatformat:1 }}
                                </div>
                        </td>
                        <td>{{ target.sun|floatformat:0 }}</td>
                        <td>{{ target.classification }}</td>
                    </tr>

                    {% empty %}
                    <tr>
                        <td colspan="5">
                            {% if target_count == 0 %}
                            No targets yet.
                            {% else %}
                            No targets match those filters.
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
        {% endcache %}
        <!-- closing table and form to add targets -->

    </div>
</div>

<!-- filters below the table (new row) -->
<div class="row">
    <div class="col-md-12">

        <h4>Filtering</h4>
        {{ filter.fields }}
        <div class="col-md-12">
            <form action="" method="get" class="form">
                {% bootstrap_form filter.form exclude='tweet,epoch,pm_ra,pm_dec,distance,distance_err,dont_update_me' %}
                <!-- {% bootstrap_form filter.form %} -->
                {% buttons %}
                <button type="submit" class="btn btn-primary">
                    Filter
                </button>
                <a href="{% url 'targets:list' %}" class="btn btn-secondary" title="Reset">Reset</a>
                <button type="submit" formaction="{% url 'targets:export' %}" id="invisible-export-button"
                    style="display:none"></button>
                {% endbuttons %}
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block javascript %}
<script src="https://code.jquery.com/jquery-3.6.1.min.js"
    integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<script type="text/javascript" src="//cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script>

    $(document).ready(function () {
        $('.table').DataTable();
        $('#DataTables_Table_0_filter').hide();
    });
</script>
{% endblock %}