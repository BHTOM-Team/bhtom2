{% extends 'bhtom_common/base.html' %}
{% load bootstrap4 static %}

{% block title %}Create observatory{% endblock %}

{% block content %}
<script src="{% static 'bhtom_observatory/create_observatory.js' %}"></script>
{{ users }}

{% if object %}
<form action="{% url 'bhtom_observatory:update' object.id %}" enctype="multipart/form-data" method="POST">
{% else %}
<h4>Create a new Observatory.</h4>
<br>
<p>
  Please fill the form below, check BHTOM manual for details.
  Your entry has to be then activated by the Administrator.
</p>
<p>
  The sample fits file is necessary for new observatories for verification of the automatic photometric processing.
  Please refer to the BHTOM Manual or get in touch.
</p>
<form action="{% url 'bhtom_observatory:create' %}" enctype="multipart/form-data" method="POST">
{% endif %}
  {% csrf_token %}
  {% bootstrap_form form %}

  <div id="alias-form-container">
    <h3>Cameras</h3>
    {{ cameras.management_form }}
    <div id="camera-fields">
      {% for form in cameras.forms %}
          <div class="camera-form">
            {% if form.instance.pk %}
              {{ form.id }}
            {% endif %}
            
            <div class="col-md-4 required-field">
              {% bootstrap_field form.camera_name %}
            </div>
            <div class="col-md-4 required-field">
              {% bootstrap_field form.example_file %}
            </div>
            <div class="col-md-4 required-field">
              {% bootstrap_field form.binning %}
            </div>
            <div class="col-md-4 required-field">
              {% bootstrap_field form.gain %}
            </div>
            <div class="col-md-4 required-field">
              {% bootstrap_field form.readout_noise %}
            </div>
            <div class="col-md-4 required-field">
              {% bootstrap_field form.saturation_level %}
            </div>
            <div class="col-md-4 required-field">
              {% bootstrap_field form.pixel_scale %}
            </div>
            <div class="col-md-4 required-field">
              {% bootstrap_field form.pixel_size %}
            </div>
            <div class="col-md-4 required-field">
              {% bootstrap_field form.readout_speed %}
            </div>
            <hr>
              <div class="line-separator"></div>
            <hr>
          </div>
          
          {% endfor %}
    </div>
    {% if object %}
      <button type="button" class="btn btn-primary" id="add-camera">Add Camera</button>
      <hr>
      {% endif %}
  </div>

  {% buttons %}
  <button type="submit" class="btn btn-primary">
    {% if object %}
      Update
    {% else %}
      Create Observatory
    {% endif %}
  </button>
  {% endbuttons %}

</form>
<script>
  $(document).ready(function() {
    $("#add-camera").click(function() {
        var cameraForm = $(".camera-form:first").clone(true);
        var totalForms = $('#id_camera_set-TOTAL_FORMS');
        var formIdx = parseInt(totalForms.val());

        // Clear all input fields
        cameraForm.find("input[type='text'], input[type='number'], input[type='file']").val("");
        
        // Update the names and IDs of the cloned fields
        cameraForm.find("input[type='text'], input[type='number'], input[type='file']").each(function() {
            var field = $(this);
            var fieldName = field.attr('name');
            var fieldId = field.attr('id');
            var newFieldName = fieldName.replace(/-\d+-/g, '-' + formIdx + '-');
            var newFieldId = fieldId.replace(/-\d+/g, '-' + formIdx);
            field.attr('name', newFieldName);
            field.attr('id', newFieldId);
        });
        
        // Insert the cloned form after the last camera form
        cameraForm.insertAfter(".camera-form:last");
        
        // Add a line separator after the cloned form
        $("<div class='line-separator'></div>").insertAfter(cameraForm);

        // Increment the total forms count
        totalForms.val(formIdx + 1);
    });
{% comment %} 

function toggleCameraFields() {
  var calibrationFlag = document.getElementById('id_calibration_flg');
  var cameraFields = cameraForm.querySelectorAll('input[type="text"], input[type="number"], input[type="file"]');
  for (var i = 0; i < cameraFields.length; i++) {
    if (calibrationFlag.checked) {
      cameraFields[i].disabled = true;
      cameraFields[i].removeAttribute('required');
      if (cameraFields[i].type === 'file') {
        cameraFields[i].value = '{% static "bhtom_observatory/sample_for_calibration_only.csv" %}';
      }
    } else {
      cameraFields[i].disabled = false;
      cameraFields[i].setAttribute('required', true);
    }
  }
}
toggleCameraFields();
document.getElementById('id_calibration_flg').addEventListener('change', toggleCameraFields); {% endcomment %}
});


</script>
{% endblock %}
